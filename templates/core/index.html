{% extends 'base.html' %}

{% block title %}0django -  Hack. Build. Launch.{% endblock %}

{% block content %}

{% include 'partial/header.html' %}

<main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 md:grid-cols-12 gap-6">
  <!-- LEFT COLUMN: Build game / Trending games / AI assistant -->
  <!-- Mobile: order-3 | Desktop: order-1 -->
  <aside class="order-3 md:order-1 md:col-span-3 space-y-4">
    <div class="sticky top-20">
      <div class="space-y-4 max-h-[calc(100vh-5rem)] overflow-y-auto">

        {% include 'partial/index-left.html' %}

      </div>
    </div>

    
  </aside>

  <!-- Feed -->
  <!-- Mobile: order-1 | Desktop: order-2 -->
  <section class="order-1 md:order-2 md:col-span-6">
    <!-- Tabs header -->
    <div class="mb-4 flex items-center justify-between">
      <div class="inline-flex rounded-lg bg-gray-100 p-1">
        <button
          type="button"
          class="tab-btn px-4 py-2 text-sm rounded-md transition"
          data-tab="latest"
          aria-controls="panel-latest"
          aria-selected="true"
        >
          Latest
        </button>
        <button
          type="button"
          class="tab-btn px-4 py-2 text-sm rounded-md transition"
          data-tab="top"
          aria-controls="panel-top"
          aria-selected="false"
        >
          Top
        </button>
      </div>
    </div>

    <!-- Panels -->
    <div id="panel-latest" role="tabpanel" class="space-y-4">
      {% for feed in latest %}
        <!-- card -->
        {% if feed.type == 'feed' %}
          <article class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">Feed</span>
              <span class="text-xs text-gray-500">by <a href="#" class="hover:underline">@{{feed.author}}</a> ‚Ä¢ {{feed.created_at|timesince}} ago</span>
            </div>
            <h2 class="font-semibold text-lg">{{feed.title}}</h2>
            {% if feed.short_description %}
            <p class="mt-2 text-sm text-gray-600">
              {{feed.short_description}}
            </p>
            {% endif %}
            {# Buttons #}
            <div class="mt-4 flex items-center gap-3 text-sm">
              <button
                class="react-btn px-3 py-1 rounded-lg border hover:bg-gray-50"
                data-id="{{ feed.id }}" data-type="1" aria-label="Like"
              >üëç <span class="like-count">{{ feed.like_count }}</span></button>

              <button
                class="react-btn px-3 py-1 rounded-lg border hover:bg-gray-50"
                data-id="{{ feed.id }}" data-type="2" aria-label="Heart"
              >‚ù§Ô∏è <span class="heart-count">{{ feed.heart_count }}</span></button>

              <span class="text-gray-500">Total: <span class="total-react">{{ feed.total_react }}</span></span>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
              <div class="flex items-center gap-4">
                <!-- <span>üí¨ 12</span><span>üëç 45</span> -->
                {% for tag in feed.tags.all %}
                  <span>{{tag.hash_name}}</span>
                {% endfor %}
              </div>
              <a href="{% url 'feed_detail_view' feed.category.slug feed.slug %}" class="text-blue-600 hover:underline">View discussion ‚Üí</a>
            </div>
          </article>
        {% else %}
          <article class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Post</span>
              <span class="text-xs text-gray-500">by <a href="#" class="hover:underline">@{{feed.author}}</a> ‚Ä¢ {{feed.created_at|timesince}} ago</span>
            </div>
            <h2 class="font-semibold text-lg">{{feed.title}}</h2>
            {% if feed.short_description %}
            <p class="mt-2 text-sm text-gray-600">
              {{feed.short_description}}
            </p>
            {% endif %}
            {# Buttons #}
            <div class="mt-4 flex items-center gap-3 text-sm">
              <button
                class="react-btn px-3 py-1 rounded-lg border hover:bg-gray-50"
                data-id="{{ feed.id }}" data-type="1" aria-label="Like"
              >üëç <span class="like-count">{{ feed.like_count }}</span></button>

              <button
                class="react-btn px-3 py-1 rounded-lg border hover:bg-gray-50"
                data-id="{{ feed.id }}" data-type="2" aria-label="Heart"
              >‚ù§Ô∏è <span class="heart-count">{{ feed.heart_count }}</span></button>

              <span class="text-gray-500">Total: <span class="total-react">{{ feed.total_react }}</span></span>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
              <div class="flex items-center gap-4">
                <!-- <span>üëç 120</span> -->
                {% for tag in feed.tags.all %}
                  <span>{{tag.hash_name}}</span>
                {% endfor %}
              </div>
              <a href="{% url 'post_detail_view' feed.category.slug feed.slug %}" class="text-blue-600 hover:underline">Read post ‚Üí</a>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>

    <div id="panel-top" role="tabpanel" class="space-y-4 hidden">
      {% for feed in top %}
        <!-- card -->
        {% if feed.type == 'feed' %}
          <article class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">Feed</span>
              <span class="text-xs text-gray-500">by <a href="#" class="hover:underline">@{{feed.author}}</a> ‚Ä¢ {{feed.created_at|timesince}} ago</span>
            </div>
            <h2 class="font-semibold text-lg">{{feed.title}}</h2>
            {% if feed.short_description %}
            <p class="mt-2 text-sm text-gray-600">
              {{feed.short_description}}
            </p>
            {% endif %}
            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
              <div class="flex items-center gap-4">
                <!-- <span>üí¨ 12</span><span>üëç 45</span> -->
                {% for tag in feed.tags.all %}
                  <span>{{tag.hash_name}}</span>
                {% endfor %}
              </div>
              <a href="{% url 'feed_detail_view' feed.category.slug feed.slug %}" class="text-blue-600 hover:underline">View discussion ‚Üí</a>
            </div>
          </article>
        {% else %}
          <article class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Post</span>
              <span class="text-xs text-gray-500">by <a href="#" class="hover:underline">@{{feed.author}}</a> ‚Ä¢ {{feed.created_at|timesince}} ago</span>
            </div>
            <h2 class="font-semibold text-lg">{{feed.title}}</h2>
            {% if feed.short_description %}
            <p class="mt-2 text-sm text-gray-600">
              {{feed.short_description}}
            </p>
            {% endif %}
            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
              <div class="flex items-center gap-4">
                <!-- <span>üëç 120</span> -->
                {% for tag in feed.tags.all %}
                  <span>{{tag.hash_name}}</span>
                {% endfor %}
              </div>
              <a href="{% url 'post_detail_view' feed.category.slug feed.slug %}" class="text-blue-600 hover:underline">Read post ‚Üí</a>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>
  </section>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.tab-btn');
    const panels = {
      latest: document.getElementById('panel-latest'),
      top: document.getElementById('panel-top'),
    };

    function activate(name) {
      // switch panel
      Object.keys(panels).forEach(k => {
        panels[k].classList.toggle('hidden', k !== name);
      });

      // style selected tab (segmented control look)
      buttons.forEach(btn => {
        const active = btn.dataset.tab === name;
        btn.setAttribute('aria-selected', active);
        btn.classList.toggle('bg-white', active);
        btn.classList.toggle('text-gray-900', active);
        btn.classList.toggle('shadow', active);
        btn.classList.toggle('text-gray-600', !active);
      });
    }

    buttons.forEach(b => b.addEventListener('click', () => activate(b.dataset.tab)));
    activate('latest'); // default
  });
</script>


  <!-- RIGHT: Quick create / Tags / Top authors -->
  <!-- Mobile: order-2 | Desktop: order-3 -->
  <aside class="order-2 md:order-3 md:col-span-3 space-y-4">

    <div class="sticky top-20">
      <div class="space-y-4 max-h-[calc(100vh-5rem)] overflow-y-auto">

        {% include 'partial/index-right.html' %}

      </div>
    </div>

  </aside>
</main>

{% include 'partial/footer.html' %}

{% endblock %}

{% block scripts %}

<script>
(function(){
  function getCSRF() {
    // n·∫øu b·∫°n render input csrftoken trong form th√¨ c√≥ th·ªÉ l·∫•y t·ª´ ƒë√≥
    var el = document.querySelector('input[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
  }

  // REACT (like/heart)
  document.addEventListener('click', function(e){
    var btn = e.target.closest('.react-btn');
    if (!btn) return;

    var feedId = btn.getAttribute('data-id');
    var type = btn.getAttribute('data-type');
    var formData = new FormData();
    formData.append('type', type);
    formData.append('csrfmiddlewaretoken', getCSRF());

    btn.disabled = true;

    fetch('/api/feeds/' + feedId + '/react/', {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(function(res){
      if (!res.ok) throw new Error('Network');
      return res.json();
    })
    .then(function(data){
      // c·∫≠p nh·∫≠t counters g·∫ßn nh·∫•t trong card
      var card = btn.closest('article, .feed-card, body');
      if (card) {
        var totalEl = card.querySelector('.total-react');
        if (totalEl) totalEl.textContent = data.total_react;

        var likeEl  = card.querySelector('.like-count');
        var heartEl = card.querySelector('.heart-count');
        if (likeEl)  likeEl.textContent  = data.like_count;
        if (heartEl) heartEl.textContent = data.heart_count;
      }
    })
    .catch(console.error)
    .finally(function(){ btn.disabled = false; });
  });

  // COMMENT submit
  document.addEventListener('submit', function(e){
    var form = e.target.closest('.comment-form');
    if (!form) return;
    e.preventDefault();

    var feedId = form.getAttribute('data-id');
    var fd = new FormData(form);

    fetch('/api/feeds/' + feedId + '/comment/', {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: fd
    })
    .then(function(res){
      if (!res.ok) throw new Error('Bad request');
      return res.json();
    })
    .then(function(data){
      if (!data.ok) return;

      // ch√®n comment m·ªõi
      var ul = document.getElementById('comment-list-' + feedId);
      if (ul) {
        var li = document.createElement('li');
        li.className = 'bg-white border rounded-xl p-4';
        li.innerHTML =
          '<div class="text-sm text-gray-500">' + data.user + ' ‚Ä¢ just now</div>' +
          '<div class="prose mt-1">' + data.content + '</div>';
        ul.prepend(li);
      }

      // reset form
      form.reset();

      // tƒÉng counter t·ªïng n·∫øu b·∫°n hi·ªÉn th·ªã
      var card = form.closest('article, .feed-card, body');
      var ctn = card && card.querySelector('.total-comment');
      if (ctn) ctn.textContent = (parseInt(ctn.textContent || '0', 10) + 1);
    })
    .catch(console.error);
  });
})();
</script>

{% endblock %}